<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Audio Explorer</title>

<style>
  body {
    margin: 0;
    background: #020402;
    color: #66ff99;
    font-family: monospace;
    overflow: hidden;
    touch-action: none;
  }

  .crt {
    position: fixed;
    inset: 0;
    pointer-events: none;
    background:
      repeating-linear-gradient(
        to bottom,
        rgba(0,255,120,0.05) 0px,
        rgba(0,255,120,0.02) 1px,
        rgba(0,0,0,0.05) 2px
      );
    mix-blend-mode: screen;
  }

  #galaxy {
    position: absolute;
    inset: 0;
    transform-origin: 0 0;
    cursor: grab;
    will-change: transform;
  }

  #galaxy.dragging { cursor: grabbing; }

  .star {
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #66ff99;
    box-shadow: 0 0 8px #66ff99;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    user-select: none;
    -webkit-user-select: none;
    touch-action: none;
  }

  .star:hover {
    box-shadow: 0 0 14px #99ffcc;
    transform: scale(1.3);
  }

  .star.playing {
    background: #99ffcc;
    box-shadow: 0 0 16px #99ffcc;
    animation: pulse 2s ease-in-out infinite;
  }

  .star.error {
    background: #ff6666;
    box-shadow: 0 0 10px #ff6666;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .star-label {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    white-space: nowrap;
    color: #66ff99;
    text-shadow: 0 0 4px rgba(0,0,0,0.85);
    pointer-events: none;
    display: none;
  }

  body.labels-on .star-label { display: block; }

  .tooltip {
    position: absolute;
    background: rgba(0, 20, 10, 0.95);
    border: 1px solid #66ff99;
    padding: 8px 10px;
    font-size: 12px;
    max-width: 260px;
    line-height: 1.4;
    display: none;
    z-index: 1000;
    pointer-events: none;
  }

  #controls {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 20, 10, 0.9);
    border: 1px solid #66ff99;
    padding: 8px 14px;
    font-size: 12px;
    min-width: 300px;
    text-align: center;
    z-index: 500;
  }

  #player { margin-bottom: 6px; }

  #progress-container {
    width: 100%;
    height: 4px;
    background: rgba(102, 255, 153, 0.2);
    margin: 6px 0;
    cursor: pointer;
  }

  #progress-bar {
    height: 100%;
    background: #66ff99;
    width: 0%;
  }

  #playback-controls {
    margin-top: 6px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  #playback-controls button, #playback-controls select {
    background: transparent;
    border: 1px solid #66ff99;
    color: #66ff99;
    padding: 3px 8px;
    cursor: pointer;
    font-family: monospace;
    font-size: 11px;
  }

  #playback-controls select option {
    background: #020402;
    color: #66ff99;
  }

  #errata-toggle, #label-toggle {
    position: fixed;
    bottom: 12px;
    background: rgba(0, 20, 10, 0.9);
    border: 1px solid #66ff99;
    color: #66ff99;
    padding: 6px 10px;
    font-size: 11px;
    cursor: pointer;
    z-index: 500;
  }

  #errata-toggle { left: 12px; }
  #label-toggle { right: 12px; }

  #errata-panel {
    position: fixed;
    bottom: 52px;
    left: 12px;
    background: rgba(0, 20, 10, 0.95);
    border: 1px solid #66ff99;
    padding: 10px 14px;
    font-size: 11px;
    max-width: 320px;
    line-height: 1.5;
    display: none;
    z-index: 500;
  }
</style>
</head>

<body>

<div id="galaxy"></div>
<div class="crt"></div>

<div id="controls">
  <div id="player">No star selected</div>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="playback-controls">
    <button id="play-pause">Play</button>
    <select id="speed-select" aria-label="Playback speed">
      <option value="0.8">0.8x</option>
      <option value="0.9">0.9x</option>
      <option value="1.0" selected>1.0x</option>
      <option value="1.25">1.25x</option>
      <option value="1.5">1.5x</option>
      <option value="1.75">1.75x</option>
      <option value="2.0">2.0x</option>
    </select>
    <span id="time-display">0:00 / 0:00</span>
  </div>
</div>

<button id="errata-toggle">Errata / Notes</button>
<button id="label-toggle">Show Labels</button>

<div id="errata-panel">
  <strong>Errata:</strong><br>
  "Mexica" is pronounced <em>Meh-SHEE-ka</em>, not "Mex-i-ca".<br>
  The letter <em>X</em> in Nahuatl represents the "sh" sound.
</div>

<audio id="audio" preload="metadata"></audio>

<script>
const galaxy = document.getElementById("galaxy");
const audio = document.getElementById("audio");
const player = document.getElementById("player");
const progressContainer = document.getElementById("progress-container");
const progressBar = document.getElementById("progress-bar");
const playPauseBtn = document.getElementById("play-pause");
const speedSelect = document.getElementById("speed-select");
const timeDisplay = document.getElementById("time-display");
const errataToggle = document.getElementById("errata-toggle");
const errataPanel = document.getElementById("errata-panel");
const labelToggle = document.getElementById("label-toggle");

let tracks = [];
let stars = [];
let currentStar = null;
let currentIndex = -1;

function viewportCenter() {
  return { x: window.innerWidth / 2, y: window.innerHeight / 2 };
}

function titleFromFilename(file) {
  return String(file || "").replace(/\.mp3$/i, "").replace(/_/g, " ");
}

function inferLang(file) {
  if (/[ء-ي]/.test(file)) return "AR";
  if (/[áéíóúñÁÉÍÓÚÑ]/.test(file)) return "ES";
  return "EN";
}

function fmtTime(s) {
  if (!Number.isFinite(s) || s < 0) return "0:00";
  const m = Math.floor(s / 60);
  const r = Math.floor(s % 60).toString().padStart(2, "0");
  return `${m}:${r}`;
}

function clearStars() {
  stars.forEach(s => s.classList.remove("playing", "error"));
}

function updateNowPlaying() {
  if (currentIndex < 0) {
    player.textContent = "No star selected";
    return;
  }
  player.textContent = `${titleFromFilename(tracks[currentIndex].file)} (${inferLang(tracks[currentIndex].file)})`;
}

errataToggle.onclick = () => {
  errataPanel.style.display = errataPanel.style.display === "block" ? "none" : "block";
};

let labelsVisible = false;
labelToggle.onclick = () => {
  labelsVisible = !labelsVisible;
  document.body.classList.toggle("labels-on", labelsVisible);
  labelToggle.textContent = labelsVisible ? "Hide Labels" : "Show Labels";
};

speedSelect.onchange = () => {
  audio.playbackRate = parseFloat(speedSelect.value);
  try { localStorage.setItem("audioExplorerSpeed", speedSelect.value); } catch {}
};

try {
  const saved = localStorage.getItem("audioExplorerSpeed");
  if (saved) {
    speedSelect.value = saved;
    audio.playbackRate = parseFloat(saved);
  }
} catch {}

audio.ontimeupdate = () => {
  if (!audio.duration) return;
  progressBar.style.width = (audio.currentTime / audio.duration * 100) + "%";
  timeDisplay.textContent = `${fmtTime(audio.currentTime)} / ${fmtTime(audio.duration)}`;
};

progressContainer.addEventListener("click", (e) => {
  if (!audio.duration) return;
  const rect = progressContainer.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  audio.currentTime = Math.max(0, Math.min(1, percent)) * audio.duration;
});

playPauseBtn.onclick = async () => {
  if (currentIndex < 0) return;
  if (audio.paused) {
    try { await audio.play(); } catch {}
  } else {
    audio.pause();
  }
};

audio.addEventListener("play", () => { playPauseBtn.textContent = "Pause"; });
audio.addEventListener("pause", () => { playPauseBtn.textContent = "Play"; });
audio.addEventListener("ended", () => {
  if (currentStar) currentStar.classList.remove("playing");
});

audio.addEventListener("error", () => {
  if (currentStar) {
    currentStar.classList.remove("playing");
    currentStar.classList.add("error");
  }
});

function clampTooltip(el, x, y) {
  const pad = 12;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  el.style.left = "0px";
  el.style.top = "0px";
  const r = el.getBoundingClientRect();
  const left = Math.min(vw - r.width - pad, Math.max(pad, x));
  const top = Math.min(vh - r.height - pad, Math.max(pad, y));
  el.style.left = left + "px";
  el.style.top = top + "px";
}

/* Deterministic placement so stars do not reshuffle on refresh. */
function hash01(str) {
  let h = 2166136261;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0) / 4294967296;
}

/* Pan state */
let panX = 0;
let panY = 0;

function applyPan() {
  galaxy.style.transform = `translate3d(${panX}px, ${panY}px, 0)`;
}

/* Pointer-based dragging with a movement threshold to distinguish tap from drag. */
let activePointerId = null;
let dragStartX = 0;
let dragStartY = 0;
let panStartX = 0;
let panStartY = 0;
let moved = false;
const CLICK_DRAG_THRESHOLD_PX = 6;

galaxy.addEventListener("pointerdown", (e) => {
  if (e.target.classList.contains("star")) return;
  activePointerId = e.pointerId;
  galaxy.setPointerCapture(activePointerId);
  galaxy.classList.add("dragging");
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  panStartX = panX;
  panStartY = panY;
  moved = false;
});

galaxy.addEventListener("pointermove", (e) => {
  if (activePointerId === null || e.pointerId !== activePointerId) return;
  const dx = e.clientX - dragStartX;
  const dy = e.clientY - dragStartY;
  if (!moved && (Math.abs(dx) > CLICK_DRAG_THRESHOLD_PX || Math.abs(dy) > CLICK_DRAG_THRESHOLD_PX)) moved = true;
  panX = panStartX + dx;
  panY = panStartY + dy;
  applyPan();
});

function endDrag(e) {
  if (activePointerId === null || e.pointerId !== activePointerId) return;
  galaxy.classList.remove("dragging");
  try { galaxy.releasePointerCapture(activePointerId); } catch {}
  activePointerId = null;
}

galaxy.addEventListener("pointerup", endDrag);
galaxy.addEventListener("pointercancel", endDrag);

/* Star click */
async function playTrack(i, star) {
  clearStars();

  const { x: cx, y: cy } = viewportCenter();
  const x = parseFloat(star.dataset.x);
  const y = parseFloat(star.dataset.y);

  const targetPanX = (cx - x);
  const targetPanY = (cy - y);

  panX = targetPanX;
  panY = targetPanY;
  applyPan();

  currentStar = star;
  currentIndex = i;
  updateNowPlaying();

  audio.src = tracks[i].file;
  audio.load();

  star.classList.add("playing");
  try {
    await audio.play();
  } catch (err) {
    star.classList.remove("playing");
    star.classList.add("error");
  }
}

function destroyGalaxy() {
  stars.forEach(s => s.remove());
  stars = [];
  galaxy.innerHTML = "";
  panX = 0;
  panY = 0;
  applyPan();
}

function buildGalaxy() {
  destroyGalaxy();
  const { x: cx, y: cy } = viewportCenter();

  tracks.forEach((track, i) => {
    const star = document.createElement("div");
    star.className = "star";
    stars.push(star);

    const a = hash01(track.file + "::a");
    const b = hash01(track.file + "::b");
    const angle = a * Math.PI * 2;
    const radius = 140 + b * 260;

    const x = cx + Math.cos(angle) * radius;
    const y = cy + Math.sin(angle) * radius;

    star.style.left = x + "px";
    star.style.top = y + "px";
    star.dataset.x = x;
    star.dataset.y = y;

    const label = document.createElement("div");
    label.className = "star-label";
    label.textContent = titleFromFilename(track.file);
    star.appendChild(label);

    const tooltip = document.createElement("div");
    tooltip.className = "tooltip";
    tooltip.innerHTML =
      `<strong>${titleFromFilename(track.file)}</strong> [${inferLang(track.file)}]<br>${track.abstract ?? ""}`;
    document.body.appendChild(tooltip);

    star.addEventListener("pointerenter", (e) => {
      tooltip.style.display = "block";
      clampTooltip(tooltip, e.clientX + 12, e.clientY + 12);
    });

    star.addEventListener("pointermove", (e) => {
      if (tooltip.style.display === "block") clampTooltip(tooltip, e.clientX + 12, e.clientY + 12);
    });

    star.addEventListener("pointerleave", () => {
      tooltip.style.display = "none";
    });

    star.addEventListener("pointerup", (e) => {
      if (moved) return;
      e.stopPropagation();
      playTrack(i, star);
    });

    galaxy.appendChild(star);
  });
}

window.addEventListener("resize", () => {
  if (!tracks.length) return;
  buildGalaxy();
  updateNowPlaying();
});

fetch("abstracts.json")
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  })
  .then(data => {
    tracks = Array.isArray(data) ? data : [];
    buildGalaxy();
  })
  .catch(() => {
    player.textContent = "Failed to load abstracts.json";
  });
</script>

</body>
</html>
