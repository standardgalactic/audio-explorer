<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Audio Explorer</title>

<style>
  body {
    margin: 0;
    background: #020402;
    color: #66ff99;
    font-family: monospace;
    overflow: hidden;
  }

  .crt {
    position: fixed;
    inset: 0;
    pointer-events: none;
    background:
      repeating-linear-gradient(
        to bottom,
        rgba(0,255,120,0.05) 0px,
        rgba(0,255,120,0.02) 1px,
        rgba(0,0,0,0.05) 2px
      );
    mix-blend-mode: screen;
  }

  #galaxy {
    position: absolute;
    inset: 0;
    transform-origin: center center;
    transition: transform 1s ease;
  }

  .star {
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #66ff99;
    box-shadow: 0 0 8px #66ff99;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }

  .star:hover {
    box-shadow: 0 0 14px #99ffcc;
    transform: scale(1.3);
  }

  .star.playing {
    background: #99ffcc;
    box-shadow: 0 0 16px #99ffcc;
    animation: pulse 2s ease-in-out infinite;
  }

  .star.error {
    background: #ff6666;
    box-shadow: 0 0 10px #ff6666;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .tooltip {
    position: absolute;
    background: rgba(0, 20, 10, 0.95);
    border: 1px solid #66ff99;
    padding: 8px 10px;
    font-size: 12px;
    max-width: 260px;
    line-height: 1.4;
    display: none;
    z-index: 1000;
    pointer-events: none;
  }

  #controls {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 20, 10, 0.9);
    border: 1px solid #66ff99;
    padding: 8px 14px;
    font-size: 12px;
    min-width: 300px;
    text-align: center;
  }

  #player {
    margin-bottom: 6px;
  }

  #progress-container {
    width: 100%;
    height: 4px;
    background: rgba(102, 255, 153, 0.2);
    margin: 6px 0;
    cursor: pointer;
  }

  #progress-bar {
    height: 100%;
    background: #66ff99;
    width: 0%;
  }

  #playback-controls {
    margin-top: 6px;
    font-size: 11px;
  }

  #playback-controls button {
    background: transparent;
    border: 1px solid #66ff99;
    color: #66ff99;
    padding: 3px 8px;
    margin: 0 3px;
    cursor: pointer;
    font-family: monospace;
    font-size: 11px;
  }

  #errata-toggle {
    position: fixed;
    bottom: 12px;
    left: 12px;
    background: rgba(0, 20, 10, 0.9);
    border: 1px solid #66ff99;
    color: #66ff99;
    padding: 6px 10px;
    font-size: 11px;
    cursor: pointer;
  }

  #errata-panel {
    position: fixed;
    bottom: 52px;
    left: 12px;
    background: rgba(0, 20, 10, 0.95);
    border: 1px solid #66ff99;
    padding: 10px 14px;
    font-size: 11px;
    max-width: 320px;
    line-height: 1.5;
    display: none;
  }
</style>
</head>

<body>

<div id="galaxy"></div>
<div class="crt"></div>

<div id="controls">
  <div id="player">No star selected</div>
  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>
  <div id="playback-controls">
    <button id="play-pause">Play / Pause</button>
    <button id="speed-toggle">1.0x</button>
    <span id="time-display">0:00 / 0:00</span>
  </div>
</div>

<button id="errata-toggle">Errata / Notes</button>

<div id="errata-panel">
  <strong>Errata:</strong><br>
  “Mexica” is pronounced <em>Meh-SHEE-ka</em>, not “Mex-i-ca”.  
  The letter <em>X</em> in Nahuatl represents the “sh” sound.
</div>

<audio id="audio" preload="metadata"></audio>

<script>
const galaxy = document.getElementById("galaxy");
const audio = document.getElementById("audio");
const player = document.getElementById("player");
const progressBar = document.getElementById("progress-bar");
const playPauseBtn = document.getElementById("play-pause");
const speedToggle = document.getElementById("speed-toggle");
const timeDisplay = document.getElementById("time-display");
const errataToggle = document.getElementById("errata-toggle");
const errataPanel = document.getElementById("errata-panel");

errataToggle.onclick = () => {
  errataPanel.style.display = errataPanel.style.display === "block" ? "none" : "block";
};

const centerX = innerWidth / 2;
const centerY = innerHeight / 2;

let tracks = [];
let stars = [];
let currentStar = null;
let currentIndex = -1;

function titleFromFilename(file) {
  return file.replace(/\.mp3$/i, "").replace(/_/g, " ");
}

function inferLang(file) {
  if (/[ء-ي]/.test(file)) return "AR";
  if (/[áéíóúñÁÉÍÓÚÑ]/.test(file)) return "ES";
  return "EN";
}

function clearStars() {
  stars.forEach(s => s.classList.remove("playing","error"));
}

function playTrack(i, star) {
  clearStars();

  const x = parseFloat(star.dataset.x);
  const y = parseFloat(star.dataset.y);
  galaxy.style.transform = `translate(${centerX - x}px, ${centerY - y}px)`;

  audio.src = tracks[i].file;
  audio.play();

  star.classList.add("playing");
  currentStar = star;
  currentIndex = i;

  player.textContent =
    `${titleFromFilename(tracks[i].file)} (${inferLang(tracks[i].file)})`;
}

audio.ontimeupdate = () => {
  if (!audio.duration) return;
  progressBar.style.width = (audio.currentTime / audio.duration * 100) + "%";

  const f = s => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,"0")}`;
  timeDisplay.textContent = `${f(audio.currentTime)} / ${f(audio.duration)}`;
};

playPauseBtn.onclick = () => audio.paused ? audio.play() : audio.pause();

const speeds = [1,1.25,1.5,1.75,2];
let speedIndex = 0;
speedToggle.onclick = () => {
  speedIndex = (speedIndex + 1) % speeds.length;
  audio.playbackRate = speeds[speedIndex];
  speedToggle.textContent = speeds[speedIndex] + "x";
};

fetch("abstracts.json")
  .then(r => r.json())
  .then(data => {
    tracks = data;
    buildGalaxy();
  });

function buildGalaxy() {
  tracks.forEach((track, i) => {
    const star = document.createElement("div");
    star.className = "star";
    stars.push(star);

    const angle = Math.random() * Math.PI * 2;
    const radius = 140 + Math.random() * 260;

    const x = centerX + Math.cos(angle) * radius;
    const y = centerY + Math.sin(angle) * radius;

    star.style.left = x + "px";
    star.style.top = y + "px";
    star.dataset.x = x;
    star.dataset.y = y;

    const tooltip = document.createElement("div");
    tooltip.className = "tooltip";
    tooltip.innerHTML =
      `<strong>${titleFromFilename(track.file)}</strong> [${inferLang(track.file)}]<br>${track.abstract}`;
    document.body.appendChild(tooltip);

    star.onmouseenter = e => {
      tooltip.style.display = "block";
      tooltip.style.left = e.clientX + 12 + "px";
      tooltip.style.top = e.clientY + 12 + "px";
    };
    star.onmousemove = e => {
      tooltip.style.left = e.clientX + 12 + "px";
      tooltip.style.top = e.clientY + 12 + "px";
    };
    star.onmouseleave = () => tooltip.style.display = "none";

    star.onclick = () => playTrack(i, star);

    galaxy.appendChild(star);
  });
}
</script>

</body>
</html>
